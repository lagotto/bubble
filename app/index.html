<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Bubble</title>

        <!-- build:css styles/main.css -->
        <link rel="stylesheet" href="styles/style.css">
        <!-- endbuild -->
    </head>
    <body>
        <script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.js"></script>
        <script src="bower_components/d3/d3.js"></script>
        <script src="bower_components/jquery/dist/jquery.js"></script>
        <script src="scripts/sample_data.js"></script>

        <!-- build:js(app) scripts/bubble_chart.js -->
        <script src="bower_components/d3-tip/index.js"></script>
        <script src="scripts/bubble_chart.js"></script>
        <!-- endbuild -->
        <div id="chart"></div>
        <button id="update">Update</button>
    </body>
<script>

// var preparedData = [{
//     citations: 20,
//     views: 200,
//     months: 30,
//     url: "http://www.google.com",
//     tooltip: "<br>hello<br>tooltip",
// },
// {
//     citations: 10,
//     views: 400,
//     months: 20,
//     url: "http://www.google.com2",
//     tooltip: "<br>hello<br>tooltip2",
// }];


// Convert, for example, into this format:
// [
// {
//     citations:
//     views:
//     months:
//     journal:
//     url:
//     tooltip:
// },
// ]

var preparedData = _.map(data["data"], function (d) {
    function monthDiff(d1, d2) {
        months = (d2.getFullYear() - d1.getFullYear()) * 12;
        months -= d1.getMonth() + 1;
        months += d2.getMonth();
        return months <= 0 ? 0 : months;
    }

    var date = new (Function.prototype.bind.apply(
        Date, [null].concat(d["issued"]["date-parts"])
    ))

    var months = monthDiff(date, new Date())

    return {
        citations: d["cited"],
        months: months,
        views: d["viewed"],
        tooltip: d["title"],
        url: d["canonical_url"],
        journal: d["title"]
    }
});

// And then configure the chart.
var bubble = new BubbleChart;

bubble.create($("#chart")[0], {
    width: 1000,
    height: 600,
    x: "months",
    y: "views",
    radius: "citations",
    category: "journal"
}, preparedData);

$("#update").click(function () {
    console.log('clicked');
    preparedData = _.map(preparedData, function (d) {
        d.months = Math.random() * 200;
        d.views = Math.random() * 10000;
        d.citations = Math.random() * 100;
        return d;
    });

    bubble.update({
        width: 1000,
        height: 600,
        x: "months",
        y: "views",
        radius: "citations",
        category: "journal"
    }, preparedData);
});

</script>
</html>
